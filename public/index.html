<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Recruitment System - Mindmap Digital</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }
        .header { background:white; padding:20px 30px; border-radius:12px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
        .logo { font-size:24px; font-weight:700; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .card { background:white; border-radius:12px; padding:24px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
        .card-title { font-size:18px; font-weight:600; color:#1f2937; margin-bottom:6px; }
        .card-subtitle { font-size:13px; color:#6b7280; margin-bottom:16px; }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:14px; margin-bottom:20px; }
        .form-group { display:flex; flex-direction:column; }
        .form-label { font-size:13px; font-weight:500; color:#374151; margin-bottom:6px; }
        .form-input { padding:10px 12px; border:1.5px solid #d1d5db; border-radius:6px; font-size:14px; transition:all 0.2s; }
        .form-input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
        .upload-area { border:2px dashed #d1d5db; border-radius:8px; padding:30px; text-align:center; cursor:pointer; transition:all 0.3s; margin-top:16px; }
        .upload-area:hover { border-color:#667eea; background:#f9fafb; }
        .upload-area.drag-over { border-color:#667eea; background:#eef2ff; }
        .upload-icon { font-size:48px; margin-bottom:12px; }
        #fileInput { display:none; }
        .file-list { margin-top:12px; }
        .file-item { background:#f3f4f6; padding:10px 14px; border-radius:6px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; font-size:13px; }
        .file-remove { color:#ef4444; cursor:pointer; font-weight:600; }
        .btn { padding:10px 20px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .btn-success { background:#10b981; color:white; }
        .btn-success:hover:not(:disabled) { background:#059669; }
        .btn-warning { background:#f59e0b; color:white; }
        .btn-warning:hover:not(:disabled) { background:#d97706; }
        .btn-neutral { background:#6b7280; color:white; }
        .btn-neutral:hover:not(:disabled) { background:#4b5563; }
        .btn-primary { background:#667eea; color:white; }
        .btn-primary:hover:not(:disabled) { background:#5568d3; }
        .controls { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
        .view-toggle { display:flex; gap:6px; margin-top:10px; }
        .toggle-btn { padding:6px 14px; border:1.5px solid #d1d5db; background:white; border-radius:6px; font-size:13px; cursor:pointer; transition:all 0.2s; }
        .toggle-btn.active { background:#667eea; color:white; border-color:#667eea; }
        table { width:100%; border-collapse:collapse; font-size:13px; }
        th { background:#f9fafb; padding:12px; text-align:left; font-weight:600; color:#374151; border-bottom:2px solid #e5e7eb; }
        td { padding:10px 12px; border-bottom:1px solid #e5e7eb; }
        tr:hover { background:#f9fafb; }
        .badge { padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; display:inline-block; }
        .badge-success { background:#d1fae5; color:#065f46; }
        .badge-warning { background:#fef3c7; color:#92400e; }
        .badge-error { background:#fee2e2; color:#991b1b; }
        .badge-info { background:#dbeafe; color:#1e40af; }
        .badge-neutral { background:#f3f4f6; color:#1f2937; }
        .alert { padding:12px 16px; border-radius:6px; margin-top:12px; font-size:13px; }
        .alert-success { background:#d1fae5; color:#065f46; border-left:4px solid #10b981; }
        .alert-error { background:#fee2e2; color:#991b1b; border-left:4px solid #ef4444; }
        .alert-warning { background:#fef3c7; color:#92400e; border-left:4px solid #f59e0b; }
        .score { font-weight:600; padding:4px 8px; border-radius:4px; }
        .score-high { background:#d1fae5; color:#065f46; }
        .score-medium { background:#fef3c7; color:#92400e; }
        .score-low { background:#fee2e2; color:#991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ü§ñ AI Recruitment System</div>
            <div style="color:#6b7280; font-size:13px;">Mindmap Digital - Automated Candidate Screening</div>
        </div>

        <!-- Upload Section -->
        <div class="card">
            <div class="card-title">üìÑ Upload Resumes with Job Requirements</div>
            <div class="card-subtitle">Define job criteria for automatic candidate filtering and scoring</div>
            
            <!-- Job Requirements Form -->
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Target Company</label>
                    <input type="text" class="form-input" id="company" placeholder="e.g., Wipro, TCS, Infosys">
                </div>
                <div class="form-group">
                    <label class="form-label">Job Role</label>
                    <input type="text" class="form-input" id="job_role" placeholder="e.g., AI Engineer, Java Developer">
                </div>
                <div class="form-group">
                    <label class="form-label">Required Notice Period (Max)</label>
                    <input type="text" class="form-input" id="required_notice_period" placeholder="e.g., 30 days, 2 months">
                </div>
                <div class="form-group">
                    <label class="form-label">Budget (LPA)</label>
                    <input type="number" class="form-input" id="budget_lpa" placeholder="e.g., 8" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Experience (Years)</label>
                    <input type="number" class="form-input" id="experience_years" placeholder="e.g., 3" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="location" placeholder="e.g., Bangalore, Remote">
                </div>
                <div class="form-group">
                    <label class="form-label">Employment Cooling Period (Months)</label>
                    <input type="number" class="form-input" id="employment_cooling_period" placeholder="e.g., 12" min="0">
                    <small style="color:#6b7280; font-size:11px; margin-top:4px;">Months since they left target company</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Interview Cooling Period (Months)</label>
                    <input type="number" class="form-input" id="interview_cooling_period" placeholder="e.g., 6" min="0">
                    <small style="color:#6b7280; font-size:11px; margin-top:4px;">Months since they interviewed at target company</small>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label">Required Skills (comma-separated, min 2 must match)</label>
                    <input type="text" class="form-input" id="required_skills" placeholder="e.g., React, Node.js, MongoDB, AWS">
                </div>
            </div>
            
            <!-- PDF Upload -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div style="font-weight:600; font-size:14px; margin-bottom:4px;">Drop PDF resumes here or click to browse</div>
                <div style="color:#6b7280; font-size:12px; margin-bottom:12px;">Candidates with 2+ matching skills will be added</div>
                <button class="btn btn-neutral" onclick="document.getElementById('fileInput').click()">Choose Files</button>
                <input type="file" id="fileInput" multiple accept=".pdf">
            </div>
            <div id="fileList" class="file-list"></div>
            <div style="margin-top:14px; display:flex; justify-content:flex-end;">
                <button class="btn btn-success" id="uploadBtn" disabled onclick="uploadFiles()">Upload & Process</button>
            </div>
            <div id="uploadAlert"></div>
        </div>

        <!-- Candidates Section -->
        <div class="card">
            <div class="controls">
                <div>
                    <div class="card-title">üë• Candidates</div>
                    <div class="card-subtitle" id="viewLabel">Latest Batch</div>
                    <div class="view-toggle">
                        <button class="toggle-btn active" id="btnCurrent" onclick="setView('current')">Latest Batch</button>
                        <button class="toggle-btn" id="btnAll" onclick="setView('all')">All Candidates</button>
                    </div>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                    <button class="btn btn-success" onclick="callAllCandidates()">üìû Call All Pending</button>
                    <button class="btn btn-warning" onclick="processCallbacks()">üîÑ Process Callbacks</button>
                    <button class="btn btn-neutral" onclick="refreshCandidates()">üîÑ Refresh</button>
                    <button class="btn btn-primary" onclick="downloadQualifiedExcel()">‚≠ê Download Qualified</button>
                    <button class="btn btn-neutral" onclick="downloadExcel()">üì• Download All</button>
                </div>
            </div>
            <div id="candidates"></div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentView = 'current';
        let currentBatchId = null;

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const uploadBtn = document.getElementById('uploadBtn');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
        });

        uploadArea.addEventListener('drop', (e) => {
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
        });

        function handleFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            renderFileList();
            uploadBtn.disabled = selectedFiles.length === 0;
        }

        function renderFileList() {
            fileList.innerHTML = selectedFiles.map((file, idx) => `
                <div class="file-item">
                    <span>üìÑ ${file.name}</span>
                    <span class="file-remove" onclick="removeFile(${idx})">Remove</span>
                </div>
            `).join('');
        }

        function removeFile(idx) {
            selectedFiles.splice(idx, 1);
            renderFileList();
            uploadBtn.disabled = selectedFiles.length === 0;
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            uploadBtn.textContent = 'Processing...';
            uploadBtn.disabled = true;

            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('resumes', file));
            
            // Add job requirements
            formData.append('company', document.getElementById('company').value);
            formData.append('job_role', document.getElementById('job_role').value);
            formData.append('required_notice_period', document.getElementById('required_notice_period').value);
            formData.append('budget_lpa', document.getElementById('budget_lpa').value);
            formData.append('experience_years', document.getElementById('experience_years').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('employment_cooling_period_months', document.getElementById('employment_cooling_period').value || '0');
            formData.append('interview_cooling_period_months', document.getElementById('interview_cooling_period').value || '0');
            formData.append('required_skills', document.getElementById('required_skills').value);

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();

                const alertDiv = document.getElementById('uploadAlert');
                const { successful, duplicates, failed, skills_mismatch } = result.stats || {};
                
                let alertClass = 'alert-success';
                let message = `‚úì Processed: ${successful || 0} added, ${duplicates || 0} duplicates, ${skills_mismatch || 0} skills mismatch, ${failed || 0} failed`;
                
                if (skills_mismatch > 0) {
                    alertClass = 'alert-warning';
                    message += `<br><small>Skills mismatch candidates were filtered out (need 2+ matching skills)</small>`;
                }

                alertDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
                setTimeout(() => alertDiv.innerHTML = '', 7000);

                // Clear form
                selectedFiles = [];
                fileList.innerHTML = '';
                fileInput.value = '';
                document.getElementById('company').value = '';
                document.getElementById('job_role').value = '';
                document.getElementById('required_notice_period').value = '';
                document.getElementById('budget_lpa').value = '';
                document.getElementById('experience_years').value = '';
                document.getElementById('location').value = '';
                document.getElementById('employment_cooling_period').value = '';
                document.getElementById('interview_cooling_period').value = '';
                document.getElementById('required_skills').value = '';
                
                uploadBtn.textContent = 'Upload & Process';
                uploadBtn.disabled = false;
                setView('current');
            } catch (err) {
                document.getElementById('uploadAlert').innerHTML = `<div class="alert alert-error">Error: ${err.message}</div>`;
                uploadBtn.textContent = 'Upload & Process';
                uploadBtn.disabled = false;
            }
        }

        function setView(view) {
            currentView = view;
            document.getElementById('btnCurrent').classList.toggle('active', view === 'current');
            document.getElementById('btnAll').classList.toggle('active', view === 'all');
            document.getElementById('viewLabel').textContent = view === 'current' ? 'Latest Batch' : 'All Candidates';
            refreshCandidates();
        }

        async function refreshCandidates() {
            const endpoint = currentView === 'current' ? '/api/candidates/latest-batch' : '/api/candidates';
            const res = await fetch(endpoint);
            const data = await res.json();
            
            if (currentView === 'current') {
                currentBatchId = data.batch_id;
            }
            
            renderCandidates(data.candidates || data);
        }

        function renderCandidates(candidates) {
            const container = document.getElementById('candidates');
            
            if (!candidates || candidates.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#6b7280;">No candidates found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Skills</th>
                            <th>Experience</th>
                            <th>Target Company</th>
                            <th>Status</th>
                            <th>Call Status</th>
                            <th>Score</th>
                            <th>Callback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${candidates.map(c => `
                            <tr>
                                <td style="font-weight:500;">${c.name}</td>
                                <td>${c.phone}</td>
                                <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${c.skills || '-'}</td>
                                <td>${c.years_of_experience || '-'}</td>
                                <td>${c.target_company || '-'}</td>
                                <td><span class="badge badge-${getStatusClass(c.status)}">${c.status}</span></td>
                                <td><span class="badge badge-${getCallStatusClass(c.call_status)}">${c.call_status || 'pending'}</span></td>
                                <td>${c.total_score ? `<span class="score ${getScoreClass(c.total_score)}">${c.total_score}/100</span>` : '-'}</td>
                                <td>${c.callback_requested ? `<span class="badge badge-warning">Yes</span><br><small>${c.callback_scheduled_time || ''}</small>` : '-'}</td>
                                <td>
                                    ${c.call_status === 'pending' || c.call_status === 'failed' ? 
                                        `<button class="btn btn-success" style="font-size:11px; padding:6px 12px;" onclick="callCandidate(${c.id})">Call</button>` : 
                                        `<button class="btn btn-neutral" style="font-size:11px; padding:6px 12px;" onclick="viewDetails(${c.id})">View</button>`
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        function getStatusClass(status) {
            const map = { active: 'success', duplicate: 'warning', failed: 'error' };
            return map[status] || 'neutral';
        }

        function getCallStatusClass(status) {
            const map = { 
                completed: 'success', 
                failed: 'error', 
                pending: 'neutral',
                'in-progress': 'info',
                callback_scheduled: 'warning'
            };
            return map[status] || 'neutral';
        }

        function getScoreClass(score) {
            if (score >= 70) return 'score-high';
            if (score >= 50) return 'score-medium';
            return 'score-low';
        }

        async function callCandidate(id) {
            if (!confirm('Start screening call for this candidate?')) return;
            
            try {
                const res = await fetch(`/api/candidates/${id}/call`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert('Call initiated successfully!');
                    refreshCandidates();
                } else {
                    alert('Error: ' + (data.error || 'Call failed'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function callAllCandidates() {
            if (!confirm('Start calling all pending candidates in the current batch?')) return;
            
            try {
                const endpoint = currentView === 'current' 
                    ? `/api/batch/${currentBatchId}/call-all`
                    : '/api/candidates/call-all';
                    
                const res = await fetch(endpoint, { method: 'POST' });
                const data = await res.json();
                
                alert(data.message || 'Calling process started');
                refreshCandidates();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function processCallbacks() {
            if (!confirm('Process all scheduled callbacks?')) return;
            
            try {
                const res = await fetch('/api/callbacks/process', { method: 'POST' });
                const data = await res.json();
                
                alert(data.message || 'Callbacks processed');
                refreshCandidates();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function downloadExcel() {
            window.location.href = '/api/export/excel';
        }

        async function downloadQualifiedExcel() {
            window.location.href = '/api/export/qualified';
        }

        function viewDetails(id) {
            window.open(`/api/candidates/${id}`, '_blank');
        }

        // Initial load
        refreshCandidates();
        setInterval(refreshCandidates, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>